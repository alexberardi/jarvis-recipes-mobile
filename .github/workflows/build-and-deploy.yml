name: Build and Deploy to TestFlight

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      environment:
        description: 'GitHub Environment'
        required: true
        default: 'jarvis-mobile-staging'
        type: choice
        options:
          - jarvis-mobile-staging
          - jarvis-mobile-prod

jobs:
  build-and-deploy:
    name: Build and Deploy iOS App
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (startsWith(github.ref, 'refs/tags/v') && 'jarvis-mobile-prod' || 'jarvis-mobile-staging') }}
    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm install

      - name: Determine build profile
        id: profile
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "profile=${{ github.event.inputs.profile }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          else
            echo "profile=preview" >> $GITHUB_OUTPUT
          fi

      - name: Build iOS app
        run: |
          # EAS Secrets configured in Expo dashboard will be used automatically during cloud builds
          # The eas.json file references these via ${EXPO_PUBLIC_*} variables
          eas build --platform ios --profile ${{ steps.profile.outputs.profile }} --non-interactive --no-wait

      - name: Submit to TestFlight
        id: submit
        run: |
          # Validate App Store Connect API key credentials
          if [ -z "${EXPO_APPLE_KEY_ID}" ] || [ -z "${EXPO_APPLE_ISSUER_ID}" ] || [ -z "${EXPO_APPLE_KEY_CONTENT}" ]; then
            echo "Missing App Store Connect API key credentials."
            echo "Ensure EXPO_APPLE_KEY_ID, EXPO_APPLE_ISSUER_ID, and EXPO_APPLE_KEY_CONTENT secrets are set."
            exit 1
          fi

          # Validate Key ID format (10 characters, alphanumeric)
          if ! [[ "${EXPO_APPLE_KEY_ID}" =~ ^[A-Z0-9]{10}$ ]]; then
            echo "EXPO_APPLE_KEY_ID must be 10 uppercase alphanumeric characters."
            exit 1
          fi

          # Validate Issuer ID format (UUID)
          if ! [[ "${EXPO_APPLE_ISSUER_ID}" =~ ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$ ]]; then
            echo "EXPO_APPLE_ISSUER_ID must be a valid UUID format."
            exit 1
          fi

          # Fetch ASC App ID from EAS Secrets
          # Try ASC_APP_ID first (secret), then fallback to EXPO_PUBLIC_ASC_APP_ID (plain text)
          ASC_APP_ID=""
          PROFILE="${{ steps.profile.outputs.profile }}"
          
          # Try to fetch from EAS Secrets using the EAS CLI
          echo "Fetching ASC App ID from EAS Secrets..."
          if EAS_SECRET=$(eas secret:list --json 2>/dev/null | jq -r ".[] | select(.name == \"ASC_APP_ID\") | .value" 2>/dev/null); then
            if [ -n "${EAS_SECRET}" ] && [ "${EAS_SECRET}" != "null" ]; then
              ASC_APP_ID="${EAS_SECRET}"
              echo "Found ASC_APP_ID in EAS Secrets"
            fi
          fi
          
          # Fallback to EXPO_PUBLIC_ASC_APP_ID if ASC_APP_ID not found
          if [ -z "${ASC_APP_ID}" ]; then
            if EAS_PUBLIC_SECRET=$(eas secret:list --json 2>/dev/null | jq -r ".[] | select(.name == \"EXPO_PUBLIC_ASC_APP_ID\") | .value" 2>/dev/null); then
              if [ -n "${EAS_PUBLIC_SECRET}" ] && [ "${EAS_PUBLIC_SECRET}" != "null" ]; then
                ASC_APP_ID="${EAS_PUBLIC_SECRET}"
                echo "Found EXPO_PUBLIC_ASC_APP_ID in EAS Secrets"
              fi
            fi
          fi
          
          # Validate and trim ASC App ID
          ASC_APP_ID=$(echo "${ASC_APP_ID}" | tr -d '[:space:]')
          if [ -z "${ASC_APP_ID}" ]; then
            echo "Missing ASC App ID from EAS Secrets."
            echo "Ensure either ASC_APP_ID or EXPO_PUBLIC_ASC_APP_ID is set in Expo EAS Secrets."
            exit 1
          fi

          # Validate ASC App ID format (numeric only)
          if ! [[ "${ASC_APP_ID}" =~ ^[0-9]+$ ]]; then
            echo "ASC_APP_ID must consist only of digits. Got: '${ASC_APP_ID}'"
            exit 1
          fi

          echo "Using App Store Connect API key authentication"
          echo "Key ID: ${EXPO_APPLE_KEY_ID}"
          echo "Issuer ID: ${EXPO_APPLE_ISSUER_ID}"
          echo "ASC App ID: ${ASC_APP_ID}"

          # Update eas.json with the ASC App ID for the current profile
          # EAS doesn't support environment variable substitution in submit section
          # Install jq for reliable JSON manipulation
          sudo apt-get update && sudo apt-get install -y jq || true
          if command -v jq &> /dev/null; then
            # Use jq if available (more reliable)
            jq --arg appId "${ASC_APP_ID}" ".submit.${PROFILE}.ios.ascAppId = \$appId" eas.json > eas.json.tmp && mv eas.json.tmp eas.json
          else
            # Fallback to sed if jq is not available
            if [[ "${PROFILE}" == "production" ]]; then
              sed -i.bak "s/\"ascAppId\": \".*\"/\"ascAppId\": \"${ASC_APP_ID}\"/" eas.json
            else
              sed -i.bak "s/\"ascAppId\": \".*\"/\"ascAppId\": \"${ASC_APP_ID}\"/" eas.json
            fi
            rm -f eas.json.bak
          fi

          eas submit --platform ios --profile ${PROFILE} --latest --non-interactive
        env:
          # App Store Connect API key credentials
          EXPO_APPLE_KEY_ID: ${{ secrets.EXPO_APPLE_KEY_ID }}
          EXPO_APPLE_ISSUER_ID: ${{ secrets.EXPO_APPLE_ISSUER_ID }}
          EXPO_APPLE_KEY_CONTENT: ${{ secrets.EXPO_APPLE_KEY_CONTENT }}

