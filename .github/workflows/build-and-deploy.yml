name: Build and Deploy to TestFlight

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      environment:
        description: 'GitHub Environment'
        required: true
        default: 'jarvis-mobile-staging'
        type: choice
        options:
          - jarvis-mobile-staging
          - jarvis-mobile-prod

jobs:
  build-and-deploy:
    name: Build and Deploy iOS App
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (startsWith(github.ref, 'refs/tags/v') && 'jarvis-mobile-prod' || 'jarvis-mobile-staging') }}
    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm install

      - name: Determine build profile
        id: profile
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "profile=${{ github.event.inputs.profile }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          else
            echo "profile=preview" >> $GITHUB_OUTPUT
          fi

      - name: Build iOS app
        run: |
          eas build --platform ios --profile ${{ steps.profile.outputs.profile }} --non-interactive --no-wait
        env:
          # Override eas.json values with secrets from GitHub Environment
          EXPO_PUBLIC_AUTH_API_BASE_URL: ${{ secrets.AUTH_API_BASE_URL }}
          EXPO_PUBLIC_RECIPES_API_BASE_URL: ${{ secrets.RECIPES_API_BASE_URL }}
          ASC_APP_ID: ${{ secrets.ASC_APP_ID}}

      - name: Submit to TestFlight
        id: submit
        run: |
          # Validate App Store Connect API key credentials
          if [ -z "${EXPO_APPLE_KEY_ID}" ] || [ -z "${EXPO_APPLE_ISSUER_ID}" ] || [ -z "${EXPO_APPLE_KEY_CONTENT}" ]; then
            echo "Missing App Store Connect API key credentials."
            echo "Ensure EXPO_APPLE_KEY_ID, EXPO_APPLE_ISSUER_ID, and EXPO_APPLE_KEY_CONTENT secrets are set."
            exit 1
          fi

          # Validate Key ID format (10 characters, alphanumeric)
          if ! [[ "${EXPO_APPLE_KEY_ID}" =~ ^[A-Z0-9]{10}$ ]]; then
            echo "EXPO_APPLE_KEY_ID must be 10 uppercase alphanumeric characters."
            exit 1
          fi

          # Validate Issuer ID format (UUID)
          if ! [[ "${EXPO_APPLE_ISSUER_ID}" =~ ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$ ]]; then
            echo "EXPO_APPLE_ISSUER_ID must be a valid UUID format."
            exit 1
          fi

          echo "Using App Store Connect API key authentication"
          echo "Key ID: ${EXPO_APPLE_KEY_ID}"
          echo "Issuer ID: ${EXPO_APPLE_ISSUER_ID}"

          eas submit --platform ios --profile ${{ steps.profile.outputs.profile }} --latest --non-interactive
        env:
          # App Store Connect API key credentials
          EXPO_APPLE_KEY_ID: ${{ secrets.EXPO_APPLE_KEY_ID }}
          EXPO_APPLE_ISSUER_ID: ${{ secrets.EXPO_APPLE_ISSUER_ID }}
          EXPO_APPLE_KEY_CONTENT: ${{ secrets.EXPO_APPLE_KEY_CONTENT }}
          # ASC App ID is still needed for submission
          EXPO_ASC_APP_ID: ${{ secrets.ASC_APP_ID }}

