name: Build and Deploy to TestFlight

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      environment:
        description: 'GitHub Environment'
        required: true
        default: 'jarvis-mobile-staging'
        type: choice
        options:
          - jarvis-mobile-staging
          - jarvis-mobile-prod

jobs:
  build-and-deploy:
    name: Build and Deploy iOS App
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (startsWith(github.ref, 'refs/tags/v') && 'jarvis-mobile-prod' || 'jarvis-mobile-staging') }}
    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm install

      - name: Determine build profile
        id: profile
        run: |
          # Build profile controls eas.json build settings
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PROFILE="${{ github.event.inputs.profile }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            PROFILE="production"
          else
            PROFILE="preview"
          fi

          # EAS environment controls which Expo Environment Variables bucket is used
          # Only use production env vars on tags; otherwise use preview env vars.
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            EAS_ENV="production"
          else
            EAS_ENV="preview"
          fi

          echo "profile=${PROFILE}" >> $GITHUB_OUTPUT
          echo "eas_env=${EAS_ENV}" >> $GITHUB_OUTPUT

          echo "Selected profile: ${PROFILE}"
          echo "Selected EAS environment: ${EAS_ENV}"

      - name: Build iOS app
        id: build
        run: |
          # Build and WAIT so we get a new finished build for this run.
          # Output JSON so we can capture the build ID deterministically.
          sudo apt-get update && sudo apt-get install -y jq || true

          BUILD_JSON=$(eas build --platform ios --profile ${{ steps.profile.outputs.profile }} --environment ${{ steps.profile.outputs.eas_env }} --non-interactive --json)
          echo "$BUILD_JSON" > build.json

          # EAS returns an array; take the first build.
          BUILD_ID=$(cat build.json | jq -r '.[0].id')
          if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
            echo "Failed to parse build id from eas build output"
            cat build.json
            exit 1
          fi

          echo "Build created: $BUILD_ID"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

      - name: Submit to TestFlight
        id: submit
        run: |
          # Validate App Store Connect API key credentials
          if [ -z "${EXPO_APPLE_KEY_ID}" ] || [ -z "${EXPO_APPLE_ISSUER_ID}" ] || [ -z "${EXPO_APPLE_KEY_CONTENT}" ]; then
            echo "Missing App Store Connect API key credentials."
            echo "Ensure EXPO_APPLE_KEY_ID, EXPO_APPLE_ISSUER_ID, and EXPO_APPLE_KEY_CONTENT secrets are set."
            exit 1
          fi

          # Validate Key ID format (10 characters, alphanumeric)
          if ! [[ "${EXPO_APPLE_KEY_ID}" =~ ^[A-Z0-9]{10}$ ]]; then
            echo "EXPO_APPLE_KEY_ID must be 10 uppercase alphanumeric characters."
            exit 1
          fi

          # Validate Issuer ID format (UUID)
          if ! [[ "${EXPO_APPLE_ISSUER_ID}" =~ ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$ ]]; then
            echo "EXPO_APPLE_ISSUER_ID must be a valid UUID format."
            exit 1
          fi

          # Fetch ASC App ID - try EAS Secrets first, fallback to GitHub secret
          # Since eas submit runs locally, EAS Secrets aren't automatically available
          # We'll try to fetch from EAS, but GitHub secret is more reliable for local execution
          ASC_APP_ID=""
          PROFILE="${{ steps.profile.outputs.profile }}"
          echo "Using EAS environment: ${{ steps.profile.outputs.eas_env }}"
          
          echo "Fetching ASC App ID..."
          
          # First, try GitHub secret (most reliable for local submit execution)
          if [ -n "${EXPO_PUBLIC_ASC_APP_ID}" ]; then
            ASC_APP_ID="${EXPO_PUBLIC_ASC_APP_ID}"
            echo "Using EXPO_PUBLIC_ASC_APP_ID from GitHub Environment secret"
          fi
          
          # Try to fetch from EAS Secrets as alternative (may not work for all secret types)
          if [ -z "${ASC_APP_ID}" ]; then
            echo "Attempting to fetch from EAS Secrets..."
            # Try EXPO_PUBLIC_ASC_APP_ID first (plain text, more likely to be accessible)
            if EAS_PUBLIC_SECRET=$(eas secret:get EXPO_PUBLIC_ASC_APP_ID --non-interactive 2>/dev/null); then
              if [ -n "${EAS_PUBLIC_SECRET}" ] && [ "${EAS_PUBLIC_SECRET}" != "null" ]; then
                ASC_APP_ID="${EAS_PUBLIC_SECRET}"
                echo "Found EXPO_PUBLIC_ASC_APP_ID in EAS Secrets"
              fi
            fi
            
            # Try ASC_APP_ID as fallback
            if [ -z "${ASC_APP_ID}" ]; then
              if EAS_SECRET=$(eas secret:get ASC_APP_ID --non-interactive 2>/dev/null); then
                if [ -n "${EAS_SECRET}" ] && [ "${EAS_SECRET}" != "null" ]; then
                  ASC_APP_ID="${EAS_SECRET}"
                  echo "Found ASC_APP_ID in EAS Secrets"
                fi
              fi
            fi
          fi
          
          # Validate and trim ASC App ID
          ASC_APP_ID=$(echo "${ASC_APP_ID}" | tr -d '[:space:]')
          if [ -z "${ASC_APP_ID}" ]; then
            echo "Error: Could not find ASC App ID."
            echo "Ensure EXPO_PUBLIC_ASC_APP_ID is set in either:"
            echo "  1. GitHub Environment secrets (recommended for submit)"
            echo "  2. Expo EAS Secrets (ASC_APP_ID or EXPO_PUBLIC_ASC_APP_ID)"
            exit 1
          fi

          # Validate ASC App ID format (numeric only)
          if ! [[ "${ASC_APP_ID}" =~ ^[0-9]+$ ]]; then
            echo "ASC_APP_ID must consist only of digits. Got: '${ASC_APP_ID}'"
            exit 1
          fi

          echo "Submitting build id: ${{ steps.build.outputs.build_id }}"
          echo "Using App Store Connect API key authentication"
          echo "Key ID: ${EXPO_APPLE_KEY_ID}"
          echo "Issuer ID: ${EXPO_APPLE_ISSUER_ID}"
          echo "ASC App ID: ${ASC_APP_ID}"

          # Update eas.json with the ASC App ID for the current profile
          # EAS doesn't support environment variable substitution in submit section
          # Install jq for reliable JSON manipulation
          sudo apt-get update && sudo apt-get install -y jq || true
          if command -v jq &> /dev/null; then
            # Use jq if available (more reliable)
            jq --arg appId "${ASC_APP_ID}" ".submit.${PROFILE}.ios.ascAppId = \$appId" eas.json > eas.json.tmp && mv eas.json.tmp eas.json
          else
            # Fallback to sed if jq is not available
            if [[ "${PROFILE}" == "production" ]]; then
              sed -i.bak "s/\"ascAppId\": \".*\"/\"ascAppId\": \"${ASC_APP_ID}\"/" eas.json
            else
              sed -i.bak "s/\"ascAppId\": \".*\"/\"ascAppId\": \"${ASC_APP_ID}\"/" eas.json
            fi
            rm -f eas.json.bak
          fi

          eas submit --platform ios --profile ${PROFILE} --environment ${{ steps.profile.outputs.eas_env }} --id ${{ steps.build.outputs.build_id }} --non-interactive --no-wait
        env:
          # App Store Connect API key credentials
          EXPO_APPLE_KEY_ID: ${{ secrets.EXPO_APPLE_KEY_ID }}
          EXPO_APPLE_ISSUER_ID: ${{ secrets.EXPO_APPLE_ISSUER_ID }}
          EXPO_APPLE_KEY_CONTENT: ${{ secrets.EXPO_APPLE_KEY_CONTENT }}
          # ASC App ID - GitHub secret as primary source for local submit execution
          # EAS Secrets are used for cloud builds, but GitHub secrets are needed for local submit
          EXPO_PUBLIC_ASC_APP_ID: ${{ secrets.EXPO_PUBLIC_ASC_APP_ID }}
